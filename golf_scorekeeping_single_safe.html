<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Golf Scorekeeping (Safe Mode)</title>
  <meta name="description" content="Mobile golf scorekeeper for 1â€“4 players, 9 or 18 holes. Safe-mode inputs for broader device compatibility." />
  <style>
    :root{
      --bg:#0b0d10; --card:#12161c; --ink:#e8eef9; --muted:#9fb0c9; --brand:#58c4ff;
      --border:#1f2733; --radius:14px; --pad:14px; --gap:12px; --touch:48px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .wrap{max-width:960px;margin:0 auto;padding:clamp(8px,2vw,16px)}
    header{position:sticky;top:0;background:#0b0d10cc;backdrop-filter:blur(6px)}
    .hdr{display:flex;align-items:center;gap:10px;padding:10px 4px 8px}
    .h1{font-size:20px;font-weight:700}
    .chip{font-size:12px;color:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:999px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);margin-top:12px}
    .panel{padding:var(--pad)}
    .row{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center}
    .col{flex:1}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    select, input[type="text"], input[type="tel"]{width:100%;background:#0c1117;color:var(--ink);border:1px solid var(--border);border-radius:12px;padding:12px;font-size:18px;min-height:44px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;background:#0c1117;border:1px solid var(--border);color:var(--ink);padding:12px 14px;border-radius:14px;min-height:var(--touch);cursor:pointer}
    .btn.small{padding:8px 10px;min-height:38px;font-size:14px}
    .grid{overflow:auto;border-top:1px solid var(--border)}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th, td{border-bottom:1px solid var(--border);padding:10px;text-align:center}
    th{position:sticky;top:0;background:#0e1319}
    th:first-child, td:first-child{text-align:left;position:sticky;left:0;background:#0e1319;z-index:2}
    .holecell input{width:100%;text-align:center;background:#0c1117;border:1px solid #2b3647;border-radius:10px;padding:10px;font-size:20px}
    .holecell input:focus{outline:2px solid var(--brand)}
    .name-input{background:transparent;border:none;border-bottom:1px dashed #2b3647;border-radius:0;padding:6px 2px}
    .totals{display:flex;gap:12px;padding:12px;border-top:1px solid var(--border);background:#0e1319;border-bottom-left-radius:var(--radius);border-bottom-right-radius:var(--radius)}
    .pill{flex:1;background:#0c1117;border:1px solid var(--border);border-radius:12px;padding:10px 12px;display:flex;align-items:center;justify-content:space-between}
  </style>
</head>
<body>
  <header>
    <div class="wrap hdr">
      <div class="h1">Golf Scorekeeping</div>
      <span class="chip" id="roundChip">â€”</span>
      <div style="flex:1"></div>
      <button class="btn small" id="wakeToggle" aria-pressed="false" title="Prevent sleep">ðŸ›Œ Wake</button>
    </div>
  </header>

  <main class="wrap" id="app">
    <section class="card">
      <div class="panel">
        <h2 style="margin:0 0 8px 0;font-size:18px">Round Setup</h2>
        <div class="row">
          <div class="col">
            <label for="holeSelect">Holes</label>
            <select id="holeSelect"><option value="9">9 holes</option><option value="18">18 holes</option></select>
          </div>
          <div class="col">
            <label for="playerCount">Players</label>
            <select id="playerCount"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select>
          </div>
        </div>
        <div class="row" id="namesRow"></div>
        <div class="row" style="margin-top:12px">
          <div style="flex:1"></div>
          <button class="btn" id="startBtn">Start / Update Round</button>
        </div>
        <p style="font-size:12px;color:#9fb0c9;margin-top:8px">Tip: You can switch 9â†”18 and rename players anytime. Scores persist.</p>
      </div>
    </section>

    <section class="card">
      <div class="panel">
        <div class="row">
          <button class="btn small" id="undoBtn">â†¶ Undo</button>
          <button class="btn small" id="clearLastBtn">âŒ« Clear Last</button>
          <button class="btn small" id="resetBtn">âŸ² Reset</button>
          <div style="flex:1"></div>
          <span style="font-size:12px;color:#9fb0c9" id="statusNote">Ready</span>
        </div>
      </div>
      <div class="grid" id="gridWrap">
        <table id="scoreTable" aria-label="Scorecard"></table>
      </div>
      <div class="totals" id="totalsRow"></div>
    </section>
  </main>

  <script>
    const STORAGE_KEY = 'golf-scorekeeping-safe-v1';
    const $ = (s,el=document)=>el.querySelector(s);

    const defaultState = ()=>({holes:9, players:['Player 1'],
      scores:Array.from({length:18},()=>Array.from({length:4},()=>null)),
      lastEdit:null, undo:[]});

    let state = load() || defaultState();

    function save(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch{} }
    function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'null'); }catch{ return null; } }
    function pushUndo(entry){ state.undo.push(entry); if(state.undo.length>200) state.undo.shift(); }

    let wakeLock=null;
    async function requestWake(){
      try{
        if('wakeLock' in navigator){
          wakeLock = await navigator.wakeLock.request('screen');
          $('#wakeToggle').setAttribute('aria-pressed','true');
        } else { note('Wake Lock not supported'); }
      }catch(e){ note('Wake failed: '+e.message); }
    }
    async function releaseWake(){ try{ await wakeLock?.release(); }catch{}; wakeLock=null; $('#wakeToggle').setAttribute('aria-pressed','false'); }

    function renderSetup(){
      $('#holeSelect').value = String(state.holes);
      $('#playerCount').value = String(Math.max(state.players.length,1));
      const row = $('#namesRow'); row.innerHTML='';
      const count = Number($('#playerCount').value);
      for(let i=0;i<count;i++){
        const wrap = document.createElement('div'); wrap.className='col';
        const lab = document.createElement('label'); lab.textContent = 'Player '+(i+1)+' name';
        const inp = document.createElement('input'); inp.type='text'; inp.className='name-input'; inp.value= state.players[i]||('Player '+(i+1));
        inp.dataset.idx=i;
        inp.addEventListener('change', (e)=>{
          const idx=Number(e.target.dataset.idx); const prev=state.players[idx]||''; const next=e.target.value;
          if(prev!==next){ pushUndo({type:'name',payload:{idx},prev}); state.players[idx]=next; save(); renderTotals(); renderHeaderChip(); }
        });
        wrap.append(lab, inp); row.append(wrap);
      }
    }

    function renderGrid(){
      const table = $('#scoreTable'); table.innerHTML='';
      const thead = document.createElement('thead');
      const hr = document.createElement('tr');
      const thHole = document.createElement('th'); thHole.textContent='Hole'; hr.append(thHole);
      const players = getActivePlayers();
      players.forEach(n=>{ const th=document.createElement('th'); th.textContent=n; hr.append(th); });
      thead.append(hr); table.append(thead);

      const tbody = document.createElement('tbody');
      for(let h=1; h<=state.holes; h++){
        const tr = document.createElement('tr');
        const tdH = document.createElement('td'); tdH.textContent=String(h); tr.append(tdH);
        players.forEach((_,pIdx)=>{
          const td=document.createElement('td'); td.className='holecell';
          const inp=document.createElement('input');
          // SAFE MODE: use type=tel for broader mobile compatibility
          inp.type='tel'; inp.inputMode='numeric'; inp.autocomplete='off'; inp.placeholder='0'; inp.maxLength=3;
          inp.value = valOrEmpty(state.scores[h-1][pIdx]);
          inp.dataset.h=h-1; inp.dataset.p=pIdx;
          inp.addEventListener('focus', ()=> state.lastEdit={row:h-1,col:pIdx});
          inp.addEventListener('input', onScoreChange);
          inp.addEventListener('change', onScoreChange);
          td.append(inp); tr.append(td);
        });
        tbody.append(tr);
      }
      table.append(tbody);
      renderTotals();
    }

    function valOrEmpty(v){ return (v==null || v==='') ? '' : String(v); }
    function getActivePlayers(){ const count = Number($('#playerCount').value||state.players.length); return Array.from({length:count},(_,i)=> state.players[i] ?? 'Player '+(i+1)); }
    function totalFor(p){ let s=0; for(let h=0;h<state.holes;h++){ const v=state.scores[h][p]; if(v!=null) s+=v; } return s; }

    function onScoreChange(e){
      const h=Number(e.target.dataset.h), p=Number(e.target.dataset.p);
      const raw=(e.target.value||'').replace(/[^0-9]/g,''); // digits only
      e.target.value = raw;
      const next = raw==='' ? null : Math.max(0, Math.min(999, parseInt(raw,10)));
      const prev = state.scores[h][p];
      if(prev===next) return;
      pushUndo({type:'score', payload:{h,p}, prev});
      state.scores[h][p]=next; save(); renderTotals();
    }

    function renderTotals(){
      const players=getActivePlayers(); const row=document.getElementById('totalsRow'); row.innerHTML='';
      players.forEach((name,i)=>{
        const box=document.createElement('div'); box.className='pill';
        const k=document.createElement('div'); k.textContent=name;
        const v=document.createElement('div'); v.textContent=String(totalFor(i));
        box.append(k,v); row.append(box);
      });
      renderHeaderChip();
    }

    function onStartUpdate(){
      const old=state.holes, next=Number($('#holeSelect').value);
      const count=Number($('#playerCount').value);
      while(state.players.length < count) state.players.push('Player '+(state.players.length+1));
      if(old!==next){ pushUndo({type:'holes',payload:{},prev:old}); state.holes=next; }
      save(); renderHeaderChip(); renderGrid();
    }

    function onUndo(){
      const e = state.undo.pop(); if(!e){ return note('Nothing to undo'); }
      if(e.type==='score'){ const {h,p}=e.payload; state.scores[h][p]=e.prev; save(); renderGrid(); note('Undo score'); }
      else if(e.type==='name'){ const {idx}=e.payload; state.players[idx]=e.prev; save(); renderSetup(); renderGrid(); note('Undo name'); }
      else if(e.type==='holes'){ const cur=state.holes; state.holes=e.prev; save(); renderHeaderChip(); renderGrid(); note('Undo holes '+cur+'â†’'+e.prev); }
    }
    function onClearLast(){ const le=state.lastEdit; if(!le) return note('No last cell'); const {row,col}=le; pushUndo({type:'score',payload:{h:row,p:col},prev:state.scores[row][col]}); state.scores[row][col]=null; save(); renderGrid(); note('Cleared'); }
    function onReset(){ if(confirm('Reset the entire round?')){ const keep={holes:state.holes,players:state.players.slice()}; state=defaultState(); state.holes=keep.holes; state.players=keep.players; save(); renderSetup(); renderHeaderChip(); renderGrid(); note('Round reset'); } }
    function renderHeaderChip(){ document.getElementById('roundChip').textContent = state.holes+' holes Â· '+getActivePlayers().length+' player'+(getActivePlayers().length>1?'s':''); }
    function note(m){ document.getElementById('statusNote').textContent=m; }

    document.getElementById('startBtn').addEventListener('click', onStartUpdate);
    document.getElementById('undoBtn').addEventListener('click', onUndo);
    document.getElementById('clearLastBtn').addEventListener('click', onClearLast);
    document.getElementById('resetBtn').addEventListener('click', onReset);
    document.getElementById('wakeToggle').addEventListener('click', async ()=>{ if(wakeLock) await releaseWake(); else await requestWake(); });
    document.addEventListener('visibilitychange', async ()=>{ if(document.visibilityState==='visible' && document.getElementById('wakeToggle').getAttribute('aria-pressed')==='true'){ await requestWake(); } });

    function init(){ if(![9,18].includes(state.holes)) state.holes=9; if(!Array.isArray(state.players)||state.players.length<1) state.players=['Player 1']; if(!Array.isArray(state.scores)||state.scores.length!==18){ state.scores=Array.from({length:18},()=>Array.from({length:4},()=>null)); } save(); renderSetup(); renderHeaderChip(); renderGrid(); }
    init();
  </script>
</body>
</html>
